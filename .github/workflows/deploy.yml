name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # 3️⃣ Deploy to CloudPanel server (FINAL NON-INTERACTIVE VERSION)
      - name: Deploy on server
        run: |
          ssh \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} \
            "export NVM_DIR=\$HOME/.nvm && \
             source \$NVM_DIR/nvm.sh && \
             export PATH=\$NVM_DIR/versions/node/v22.20.0/bin:\$PATH && \
             cd ${{ secrets.APP_PATH }} && \
             git pull origin main && \
             npm install && \
             npm run build && \
             pm2 restart stocklaabh"
